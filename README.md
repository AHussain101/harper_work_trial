# Harper AI Sales Assistant

An AI-powered agentic system for insurance brokers that manages account memory through a filesystem-based architecture. The system uses Claude as the reasoning engine, Qdrant for semantic search, and structured markdown-based memory for transparency and auditability.

## Features

- **Multi-Agent Architecture** - Starter Agent routes to specialized Search, Updater, and Follow-Up agents
- **Semantic Account Search** - Find accounts by company name or attributes (stage, location, industry)
- **File-Based Memory** - All account data stored as readable markdown files
- **Agent Skills** - Modular instruction system with progressive context loading
- **Audit Trail** - Complete history tracking with linked entries (history chain)
- **Automated Follow-Ups** - Stage-based follow-up detection and communication drafting
- **Smart Clarification UI** - Interactive forms for vague updates and new account creation
- **REST API + React UI** - Interactive web interface with real-time agent visualization

## Architecture

```
User Query → Starter Agent → Routes to appropriate agent → Result
                 ↓
         Intent Classification
                 ↓
    ┌───────────┼───────────┐
    ↓           ↓           ↓
Search      Updater     Follow-Up
Agent       Agent       Agent
(read)      (write)     (automation)
```

## Tech Stack

| Component | Technology |
|-----------|------------|
| LLM | Claude (Anthropic API) |
| Embeddings | OpenAI |
| Vector DB | Qdrant |
| Backend | FastAPI + Uvicorn |
| Frontend | React + TypeScript + Vite |
| Memory Storage | Markdown files |

## Setup

### Prerequisites

- Python 3.8+
- Node.js 18+
- Qdrant running locally or in cloud
- API keys for Anthropic and OpenAI

### Installation

1. Clone the repository:
```bash
git clone https://github.com/AHussain101/harper_work_trial.git
cd harper_work_trial
```

2. Install Python dependencies:
```bash
pip install -r requirements.txt
```

3. Install UI dependencies:
```bash
cd ui && npm install && cd ..
```

4. Create a `.env` file with your API keys:
```env
ANTHROPIC_API_KEY=your_anthropic_key
OPENAI_API_KEY=your_openai_key
QDRANT_URL=http://localhost:6333
```

5. Run the ingestion pipeline (if starting fresh):
```bash
python ingest.py
```

To clear stale Qdrant references and re-ingest:
```bash
python ingest.py --clean
```

## Usage

### Start the API Server

```bash
python server.py
```

The server runs on `http://localhost:8000`.

### Start the React UI

```bash
cd ui && npm run dev
```

The UI runs on `http://localhost:5173`.

### API Endpoints

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/query` | POST | Main entry - routes through Starter Agent |
| `/confirm` | POST | Handle confirmation for pending actions |
| `/search` | POST | Direct access to Search Agent |
| `/query/stream` | POST | SSE streaming for real-time exploration |
| `/followup/pending` | GET | List accounts needing follow-up |
| `/followup/draft` | POST | Draft a follow-up communication |
| `/followup/execute` | POST | Execute a follow-up action |
| `/health` | GET | Health check |

## Project Structure

```
harper_v3/
├── server.py           # FastAPI REST server
├── starter_agent.py    # Intent classification & routing
├── search_agent.py     # Read-only exploration agent
├── updater_agent.py    # State updates & history chain
├── followup_agent.py   # Automated follow-up workflows
├── name_registry.py    # Qdrant vector search
├── ingest.py           # Data ingestion pipeline
├── skills/             # Agent Skills (persistent, not regenerated)
│   ├── search/         # Search agent skills
│   ├── update/         # Updater agent skills
│   └── followup/       # Follow-up agent skills
├── mem/
│   └── accounts/       # Account memory (regenerated by ingest.py)
│       └── {id}/
│           ├── state.md    # Current account info
│           ├── history.md  # Change log (linked list)
│           └── sources/    # Communications
│               ├── emails/
│               ├── calls/
│               └── sms/
├── ui/                 # React frontend
│   ├── src/
│   │   ├── components/ # UI components
│   │   ├── hooks/      # Custom React hooks
│   │   └── types/      # TypeScript types
│   └── package.json
└── requirements.txt
```

## The Four Agents

| Agent | File | Purpose |
|-------|------|---------|
| **Starter** | `starter_agent.py` | Intent classification, account resolution, routing |
| **Search** | `search_agent.py` | Read-only exploration, answers questions |
| **Updater** | `updater_agent.py` | Account creation, state updates, history chain, Qdrant refresh |
| **Follow-Up** | `followup_agent.py` | Automated follow-up scanning, drafting, execution |

## Smart Clarification Features

### New Account Creation with Details

When creating a new account, an expandable form lets you optionally add:
- Industry (Healthcare, Construction, Manufacturing, etc.)
- Location (City, State)
- Primary contact email and phone
- Insurance types interested in (multi-select)
- Additional notes

Account creation is handled by the **Updater Agent** using the `account-create` skill, ensuring all write operations go through a single agent.

### Vague Update Clarification

When an update request is too vague (e.g., "update this account"), the system prompts for specifics:
- Pipeline Stage dropdown (with current value shown)
- Insurance Types multi-select
- Next Step text input
- Note textarea

This ensures updates are always intentional and specific.

### Ambiguous Account Queries

When a query clearly needs a specific account but doesn't mention one (e.g., "What did the customer say in the call?"), the system asks for clarification:

> "Which account are you asking about? You can provide the company name or describe them (e.g., 'the childcare center in Texas')."

This prevents failed searches and guides users to provide the necessary context.

## Agent Tools

| Tool | Purpose |
|------|---------|
| `lookup_account` | Find accounts by company name |
| `search_descriptions` | Find accounts by attributes |
| `list_files` | List files at a path |
| `read_file` | Read file contents |
| `search_files` | Search text within files |

## Source Evidence Requirement

The Search Agent enforces **source evidence verification**. Every answer must cite at least one source file (from `sources/emails/`, `sources/calls/`, or `sources/sms/`), not just `state.md`. This ensures all claims are backed by primary evidence from actual communications.

If the agent tries to answer using only `state.md`, the system rejects the answer and prompts it to read source files first.

## UI Components

The React frontend includes specialized modals for different interaction flows:

| Modal | When Shown | Purpose |
|-------|------------|---------|
| **ConfirmationModal** | Account not found | Create new account with optional details form |
| **ClarificationModal** | Intent unclear | Suggest rephrased queries |
| **VagueUpdateClarificationModal** | Update too vague | Form to specify exact changes |

## Documentation

See [PROJECT_SPEC.md](PROJECT_SPEC.md) for detailed architecture, data flows, API response formats, and design decisions.

## License

MIT
